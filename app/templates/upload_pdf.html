<!-- app/templates/upload_pdf.html -->
<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <title>导入 PDF（ZIP）</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;padding:16px}
    .box{border:1px dashed #aaa;padding:20px;border-radius:8px;margin:12px 0}
    .btn{display:inline-block;padding:8px 14px;border:1px solid #333;background:#111;color:#fff;border-radius:4px;text-decoration:none;cursor:pointer}
    .row{margin:12px 0}
    .bar{height:8px;background:#eee;border-radius:4px;overflow:hidden}
    .bar>i{display:block;height:100%;background:#111;width:0%}
    .small{font-size:12px;color:#666}
    input[type=file]{display:block;margin:8px 0}
  </style>
</head>
<body>
  <h2>导入 PDF（ZIP）</h2>
  <div class="box">
    <input id="file" type="file" accept=".zip" />
    <button class="btn" onclick="start()">开始导入</button>
    <div class="row">
      <div class="bar"><i id="bar"></i></div>
      <p id="txt" class="small">等待选择文件...</p>
    </div>
  </div>

<script>
let pid = null;

async function start(){
  const f = document.getElementById('file').files[0];
  if(!f){ alert("请选择 ZIP 文件"); return; }
  pid = await newProgress("upload_pdfs");
  await uploadWithProgress(f, pid);       // 前端上传进度
  await watchServerStages(pid);           // 服务器解压/重打包进度
}

async function newProgress(tag){
  const r = await fetch("/admin/progress/new?tag="+encodeURIComponent(tag));
  const j = await r.json(); return j.id;
}

async function uploadWithProgress(file, pid){
  return new Promise((resolve,reject)=>{
    const bar=document.getElementById("bar");
    const txt=document.getElementById("txt");
    const xhr=new XMLHttpRequest();
    xhr.open("POST","/admin/upload-pdf");
    const fd=new FormData();
    fd.append("zipfile_upload", file);
    fd.append("progress_id", pid);
    xhr.upload.onprogress = (e)=>{
      if(e.lengthComputable){
        const pct=Math.min(95, Math.round(e.loaded*100/e.total));
        bar.style.width=pct+"%";
        txt.textContent="上传中："+pct+"% ("+Math.round(e.loaded/1048576)+"MB/"+Math.round(e.total/1048576)+"MB)";
      }else{
        txt.textContent="上传中... ("+Math.round(e.loaded/1048576)+"MB)";
      }
    };
    xhr.onreadystatechange = ()=>{
      if(xhr.readyState===4){
        if(xhr.status>=200 && xhr.status<400){
          resolve();
        }else{
          reject(new Error("上传失败: "+xhr.status));
        }
      }
    };
    xhr.onerror = ()=>reject(new Error("网络错误"));
    xhr.send(fd);
  });
}

async function watchServerStages(pid){
  const bar=document.getElementById("bar");
  const txt=document.getElementById("txt");
  while(true){
    const r=await fetch("/admin/progress/get?id="+pid,{cache:"no-store"});
    const s=await r.json();
    if(s.missing){ txt.textContent="任务不存在"; return; }
    bar.style.width = (s.pct||0)+"%";
    txt.textContent = (s.stage||"-")+"："+(s.note||"")+"（"+(s.pct||0)+"%）";
    if(s.done){ break; }
    await new Promise(r=>setTimeout(r,800));
  }
  txt.textContent = "完成："+txt.textContent;
}
</script>
</body>
</html>
