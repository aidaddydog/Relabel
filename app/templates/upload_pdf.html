<!doctype html><html><head><meta charset="utf-8"><title>PDF导入</title>
<link href="/static/admin.css" rel="stylesheet"></head>
<body>
{% include "_nav.html" %}
<div class="container">
  <div class="card" style="max-width:720px; margin:0 auto;">
    <h2 style="margin-top:0;">PDF 导入</h2>
    <div class="row">
      <input type="file" id="zipInput" accept=".zip" class="input" style="flex:2">
      <button id="btn" class="btn primary" style="flex:1"><span class="spinner"></span><span>确认导入</span></button>
    </div>
    <div id="uploadBox" style="margin-top:12px; display:none;">
      <div class="row" style="gap:8px;">
        <div style="width:60px; color:#cfd3da;">上传</div>
        <progress id="upProg" value="0" max="100"></progress>
        <div style="width:40px; text-align:right;"><span id="upPct">0%</span></div>
      </div>
      <div class="row" style="gap:8px;">
        <div style="width:60px; color:#cfd3da;">导入</div>
        <progress id="apProg" value="0" max="100"></progress>
        <div style="width:40px; text-align:right;"><span id="apPct">0%</span></div>
      </div>
    </div>
    <div id="log" class="card" style="margin-top:12px;"></div>
  </div>
</div>
<script>
function $(s){ return document.querySelector(s); }
function log(t){ const d=$("#log"); d.innerHTML += (d.innerHTML?'<br>':'') + t; }
$("#btn").addEventListener("click", async ()=>{
  const f = $("#zipInput").files?.[0];
  if(!f){ alert("请选择 zip"); return; }
  $("#uploadBox").style.display = "block";
  $("#upProg").value = 0; $("#apProg").value = 0; $("#upPct").textContent = "0%"; $("#apPct").textContent = "0%";
  const fd = new FormData(); fd.append("zipfile_upload", f);
  const tmpName = await new Promise((resolve, reject)=>{
    const xhr = new XMLHttpRequest();
    xhr.open("POST", "/admin/api/upload-pdf-file");
    xhr.upload.onprogress = (e)=>{ if(e.lengthComputable){ const pct=Math.round(e.loaded*100/e.total); $("#upPct").textContent=pct+"%"; $("#upProg").value=pct; } };
    xhr.onload = ()=>{ try{ const j=JSON.parse(xhr.responseText||"{}"); if(xhr.status>=200&&xhr.status<300 && j.ok){ resolve(j.tmp); } else { reject(new Error(j.error||"上传失败")); } }catch(e){ reject(e); } };
    xhr.onerror = ()=>reject(new Error("上传失败"));
    xhr.send(fd);
  }).catch(err=>{ alert(err.message||err); throw err; });

  await new Promise((resolve, reject)=>{
    const es = new EventSource("/admin/api/upload-pdf-apply?tmp="+encodeURIComponent(tmpName));
    let total=0, done=0;
    es.onmessage = (ev)=>{
      try{
        const d = JSON.parse(ev.data||"{}");
        if(d.phase==='read'){ total=d.total||0; }
        else if(d.phase==='progress'){ done=d.done||0; if(total){ const pct=Math.round(done*100/total); $("#apPct").textContent = pct+"%"; $("#apProg").value=pct; } }
        else if(d.phase==='done'){ $("#apPct").textContent = "100%"; $("#apProg").value=100; log("导入完成"); es.close(); resolve(); }
        else if(d.phase==='error'){ log("错误："+(d.msg||"")); es.close(); reject(new Error(d.msg||"错误")); }
      }catch(e){ console.error(e); }
    };
  });
  alert("已完成导入");
});
</script>
</body></html>
