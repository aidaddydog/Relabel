<!doctype html><html><head><meta charset="utf-8"><title>PDF导入</title></head>
<body>
{% include "_nav.html" %}
<div class="container">
  <div class="card" style="max-width:720px; margin:0 auto;">
    <h2 style="margin-top:0;">PDF 导入</h2>
    <div class="row">
      <input type="file" id="zipInput" accept=".zip" class="input" style="flex:2">
      <button id="btn" class="btn primary" style="flex:1"><span class="spinner"></span><span>确认导入</span></button>
    </div>
    <div id="uploadBox" style="margin-top:12px; display:none;">
      <div class="row" style="gap:8px;">
        <div style="width:60px; color:#cfd3da;">上传</div>
        <progress id="upProg" value="0" max="100"></progress>
        <div style="width:40px; text-align:right;"><span id="upPct">0%</span></div>
      </div>
    </div>
    <pre id="log" class="card" style="margin-top:12px; background:#0f1114;"></pre>
  </div>
</div>
<script>
const $ = s => document.querySelector(s);
const log = m => { const pre=$("#log"); pre.textContent += m+"\n"; pre.scrollTop = pre.scrollHeight; };
const btn = $("#btn");

btn.addEventListener("click", async () => {
  const f = $("#zipInput").files[0];
  if (!f) { alert("请选择 ZIP 文件"); return; }
  btn.classList.add("is-loading"); btn.disabled = true;
  $("#uploadBox").style.display = "block"; $("#upPct").textContent = "0%"; $("#upProg").value = 0;
  $("#log").textContent = "";

  try {
    // 1) 上传
    const fd = new FormData(); fd.append("zipfile_upload", f);
    const tmpName = await new Promise((resolve, reject) => {
      const xhr = new XMLHttpRequest();
      xhr.open("POST", "/admin/api/upload-pdf-file");
      xhr.upload.onprogress = (e) => {
        if (e.lengthComputable) {
          const pct = Math.round(e.loaded * 100 / e.total);
          $("#upPct").textContent = pct + "%"; $("#upProg").value = pct;
        }
      };
      xhr.onload = () => {
        try {
          const j = JSON.parse(xhr.responseText || "{}");
          if (xhr.status>=200 && xhr.status<300 && j.ok) resolve(j.tmp);
          else reject(new Error("上传失败: "+xhr.status));
        } catch(e){ reject(e); }
      };
      xhr.onerror = () => reject(new Error("网络错误"));
      xhr.send(fd);
    });

    log("上传完成，开始解压/导入/重建ZIP…");

    // 2) SSE 监听后端进度
    await new Promise((resolve, reject) => {
      const es = new EventSource(`/admin/api/apply-pdf-import?tmp=${encodeURIComponent(tmpName)}`);
      es.onmessage = (ev) => {
        try {
          const d = JSON.parse(ev.data);
          if (d.phase === "unzip" && d.total && d.done !== undefined) {
            log(`解压进度：${d.done}/${d.total}`);
          } else if (d.phase === "repack") {
            log(d.msg || "正在重建ZIP…");
          } else if (d.phase === "done") {
            log(`完成：导入 ${d.saved || 0}，跳过 ${d.skipped || 0}`);
            es.close();
            alert("导入成功！");
            window.location.href = d.redirect || "/admin/files";
            resolve();
          } else if (d.phase === "error") {
            es.close(); reject(new Error(d.msg || "处理失败"));
          }
        } catch(e){ console.error(e); }
      };
      es.onerror = (e) => { es.close(); reject(new Error("SSE 连接中断")); };
    });

  } catch (e) {
    console.error(e); alert(e.message || e);
  } finally {
    btn.classList.remove("is-loading"); btn.disabled = false;
  }
});
</script>
</body></html>
