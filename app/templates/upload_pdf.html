<!doctype html><html><head><meta charset="utf-8"><title>PDF导入</title></head>
<body>
{% include "_nav.html" %}
<div style="padding:16px;max-width:720px">
  <h2>PDF 导入</h2>
  <input type="file" id="zipInput" accept=".zip">
  <button id="btn" style="margin-left:8px;padding:6px 12px">确认导入</button>

  <div id="uploadBox" style="margin-top:12px;display:none">
    <div>上传：<span id="upPct">0%</span></div>
    <progress id="upProg" value="0" max="100" style="width:100%"></progress>
  </div>

  <pre id="log" style="margin-top:12px;background:#f7f7f7;padding:10px;height:220px;overflow:auto"></pre>
</div>

<script>
const $ = sel => document.querySelector(sel);
const log = (m) => { const pre = $("#log"); pre.textContent += m + "\n"; pre.scrollTop = pre.scrollHeight; };
const btn = $("#btn");

btn.addEventListener("click", async () => {
  const f = $("#zipInput").files[0];
  if (!f) { alert("请选择 ZIP 文件"); return; }
  btn.disabled = true; const old = btn.textContent; btn.textContent = "处理中… ⏳";
  $("#uploadBox").style.display = "block"; $("#upPct").textContent = "0%"; $("#upProg").value = 0;
  $("#log").textContent = "";

  try {
    // 1) 先上传，仅用于显示“上传进度”
    const fd = new FormData(); fd.append("zipfile_upload", f);
    const xhr = new XMLHttpRequest();
    const tmpName = await new Promise((resolve, reject) => {
      xhr.open("POST", "/admin/api/upload-pdf-file");
      xhr.upload.onprogress = (e) => {
        if (e.lengthComputable) {
          const pct = Math.round(e.loaded * 100 / e.total);
          $("#upPct").textContent = pct + "%"; $("#upProg").value = pct;
        }
      };
      xhr.onload = () => {
        if (xhr.status >= 200 && xhr.status < 300) {
          try { const j = JSON.parse(xhr.responseText); if (j.ok) resolve(j.tmp); else reject(new Error("上传失败")); }
          catch(e){ reject(e); }
        } else reject(new Error("上传接口返回 " + xhr.status));
      };
      xhr.onerror = () => reject(new Error("网络错误"));
      xhr.send(fd);
    });

    log("上传完成，开始解压/导入/重建ZIP…");

    // 2) SSE 监听后端进度
    await new Promise((resolve, reject) => {
      const es = new EventSource(`/admin/api/apply-pdf-import?tmp=${encodeURIComponent(tmpName)}`);
      es.onmessage = (ev) => {
        try {
          const d = JSON.parse(ev.data);
          if (d.phase === "unzip" && d.total && d.done !== undefined) {
            log(`解压进度：${d.done}/${d.total}`);
          } else if (d.phase === "repack") {
            log(d.msg || "正在重建ZIP…");
          } else if (d.phase === "done") {
            log(`完成：导入 ${d.saved || 0}，跳过 ${d.skipped || 0}`);
            es.close();
            alert("导入成功！");
            window.location.href = d.redirect || "/admin/files";
            resolve();
          } else if (d.phase === "error") {
            es.close(); reject(new Error(d.msg || "处理失败"));
          }
        } catch(e){ console.error(e); }
      };
      es.onerror = (e) => { es.close(); reject(new Error("SSE 连接中断")); };
    });

  } catch (e) {
    console.error(e); alert(e.message || e);
  } finally {
    btn.disabled = false; btn.textContent = old;
  }
});
</script>
</body></html>
