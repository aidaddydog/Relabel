<!doctype html><html><head><meta charset="utf-8"><title>订单导入预览</title>
<link href="/static/admin.css" rel="stylesheet"></head>
<body>
{% include "_nav.html" %}
<div class="container">
  <div class="card">
    <h2 style="margin-top:0;">导入预览（前50行）</h2>
    <div class="helper">确认后将按下方顺序写入</div>
    <div class="card" style="padding:0;margin-top:12px;">
      <table class="table">
        <tr><th>订单号</th><th>运单号</th></tr>
        {% for r in rows %}
          <tr><td>{{ r[0] }}</td><td>{{ r[1] }}</td></tr>
        {% endfor %}
      </table>
    </div>

    <div style="display:flex; gap:10px; margin-top:12px;">
      <button id="btnApply" class="btn primary"><span class="spinner"></span><span>确认写入</span></button>
      <a class="btn" href="/admin/upload-orders">返回重选</a>
    </div>

    <div id="log" class="card" style="margin-top:12px; font-family:ui-monospace,monospace;"></div>
  </div>
</div>

<script>
const token = "{{ token }}";
const order_col = "{{ order_col }}";
const tracking_col = "{{ tracking_col }}";
function log(s){ const d=document.getElementById('log'); d.innerHTML += (d.innerHTML?'<br>':'') + s; }
document.getElementById('btnApply').addEventListener('click', ()=>{
  const btn = document.getElementById('btnApply'); btn.classList.add('is-loading'); btn.disabled = true;
  const es = new EventSource(`/admin/api/orders-apply?token=${encodeURIComponent(token)}&order_col=${encodeURIComponent(order_col)}&tracking_col=${encodeURIComponent(tracking_col)}`);
  es.onmessage = (ev)=>{
    try{
      const d = JSON.parse(ev.data||"{}");
      if(d.phase==='read'){ log('读取完成，待导入总数：'+d.total); }
      else if(d.phase==='progress'){ log(`写入进度：${d.done}/${d.total}`); }
      else if(d.phase==='done'){ log(`导入完成：${d.count}`); es.close(); btn.classList.remove('is-loading'); btn.disabled=false; }
      else if(d.phase==='error'){ log('错误：'+(d.msg||'')); es.close(); btn.classList.remove('is-loading'); btn.disabled=false; }
    }catch(e){ console.error(e); }
  };
});
</script>
</body></html>
