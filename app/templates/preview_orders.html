<!-- app/templates/preview_orders.html -->
<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <title>导入订单 - 预览与确认</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;padding:16px}
    table{border-collapse:collapse;width:100%}
    th,td{border-bottom:1px solid #eee;padding:6px;text-align:left}
    .btn{display:inline-block;padding:8px 14px;border:1px solid #333;background:#111;color:#fff;border-radius:4px;text-decoration:none;cursor:pointer}
    .bar{height:8px;background:#eee;border-radius:4px;overflow:hidden;margin-top:8px}
    .bar>i{display:block;height:100%;background:#111;width:0%}
    .small{font-size:12px;color:#666}
  </style>
</head>
<body>
  <h2>导入订单 - 预览与确认</h2>
  <p>以下为前 50 行预览：</p>
  <table>
    <thead><tr><th>订单号</th><th>运单号</th></tr></thead>
    <tbody>
      {% for row in rows %}
      <tr><td>{{ row[0] }}</td><td>{{ row[1] }}</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <p><button class="btn" onclick="commit()">确认写入</button></p>
  <div class="bar"><i id="bar"></i></div>
  <p id="txt" class="small">等待执行...</p>

<script>
async function newProgress(tag){
  const r = await fetch("/admin/progress/new?tag="+encodeURIComponent(tag));
  const j = await r.json(); return j.id;
}
async function commit(){
  const pid = await newProgress("import_orders");
  const fd = new FormData();
  fd.append("progress_id", pid);
  const resp = await fetch("/admin/upload-orders-step3", {method:"POST", body:fd});
  if(!resp.ok){ alert("提交失败"); return; }
  // 跟进进度
  const bar=document.getElementById("bar");
  const txt=document.getElementById("txt");
  while(true){
    const r=await fetch("/admin/progress/get?id="+pid,{cache:"no-store"});
    const s=await r.json();
    if(s.missing){ txt.textContent="任务不存在"; return; }
    bar.style.width = (s.pct||0)+"%";
    txt.textContent = (s.stage||"-")+"："+(s.note||"")+"（"+(s.pct||0)+"%）";
    if(s.done){ break; }
    await new Promise(r=>setTimeout(r,800));
  }
  txt.textContent = "完成："+txt.textContent;
}
</script>
</body>
</html>
