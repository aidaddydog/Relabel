<!doctype html><html><head><meta charset="utf-8"><title>订单导入预览</title></head>
<body>
{% include "_nav.html" %}
<div style="padding:16px;max-width:900px">
  <h2>导入预览（前50行）</h2>
  <table border="1" cellspacing="0" cellpadding="4">
    <tr><th>订单号</th><th>运单号</th></tr>
    {% for r in rows %}
      <tr><td>{{ r[0] }}</td><td>{{ r[1] }}</td></tr>
    {% endfor %}
  </table>
  <div style="margin-top:12px">
    <button id="btn">确认导入</button>
  </div>
  <pre id="log" style="margin-top:12px;background:#f7f7f7;padding:10px;height:220px;overflow:auto"></pre>
</div>
<script>
const $ = s=>document.querySelector(s);
const log = m => { const pre=$("#log"); pre.textContent += m+"\n"; pre.scrollTop = pre.scrollHeight; };
const btn = $("#btn");
btn.addEventListener("click", async () => {
  btn.disabled = true; const old = btn.textContent; btn.textContent = "导入中… ⏳";
  $("#log").textContent = "";
  try {
    await new Promise((resolve, reject) => {
      const es = new EventSource("/admin/api/orders-apply");
      es.onmessage = (ev) => {
        const d = JSON.parse(ev.data);
        if (d.phase === "read") {
          log("读取完成，待导入总数："+d.total);
        } else if (d.phase === "progress") {
          log(`写入进度：${d.done}/${d.total}`);
        } else if (d.phase === "done") {
          log(`导入完成：${d.count}`);
          es.close();
          alert("导入成功！");
          window.location.href = d.redirect || "/admin/orders";
          resolve();
        } else if (d.phase === "error") {
          es.close(); reject(new Error(d.msg || "导入失败"));
        }
      };
      es.onerror = () => { es.close(); reject(new Error("SSE 连接中断")); };
    });
  } catch(e) {
    alert(e.message || e);
  } finally {
    btn.disabled = false; btn.textContent = old;
  }
});
</script>
</body></html>
