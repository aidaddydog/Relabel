{% include "_nav.html" %}
<div class="container">
  <h2 style="margin-top:0;">编辑：<code>{{path}}</code> <span class="muted">（{{cn}}）</span></h2>
  {% if request.query_params.get('saved') %}<div class="ok">已保存（已自动备份到 updates/template-backups/）。</div>{% endif %}

  <div class="split2">
    <div class="card editor-pane">
      <form id="editForm" method="post" action="/admin/templates/save">
        <input type="hidden" name="kind" value="{{kind}}">
        <input type="hidden" name="path" value="{{path}}">
        <textarea id="editor" name="content" class="editor" spellcheck="false">{{content}}</textarea>
        <div class="row" style="margin-top:8px">
          <button class="btn primary" type="submit">保存</button>
          <button class="btn" id="btnSavePreview" type="button">保存并预览</button>
          <button class="btn" id="btnPreview" type="button">预览（不保存）</button>
          <a class="btn" href="/admin/templates">返回列表</a>
        </div>
      </form>
    </div>
    <div class="card">
      <iframe id="preview" style="width:100%; height:70vh; border:0; background:#fff;"></iframe>
    </div>
  </div>
</div>
<script>
const iframe = document.getElementById('preview');
const editor = document.getElementById('editor');
const kind = "{{kind}}"; const path = "{{path}}";
function reloadSaved(){
  iframe.src = `/admin/templates/preview?kind=${encodeURIComponent(kind)}&path=${encodeURIComponent(path)}&ts=${Date.now()}`;
}
document.getElementById('btnSavePreview').addEventListener('click', function(){
  document.getElementById('editForm').submit();
  setTimeout(reloadSaved, 800);
});
document.getElementById('btnPreview').addEventListener('click', function(){
  const code = editor.value || '';
  if (kind === 'static') {
    const ext = path.split('.').pop().toLowerCase();
    if (ext === 'css') {
      iframe.srcdoc = `<style>${code}</style><div style="padding:20px">CSS 已载入（仅预览）</div>`;
      return;
    }
  }
  iframe.srcdoc = code;
});
</script>
